<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система автоматической оценки экзаменов - Enhanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap me-2"></i>
                Автооценка экзаменов Enhanced
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Главная</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#features">Возможности</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#example">Пример данных</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Главный контент -->
    <div class="container mt-4">
        <!-- Заголовок -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-4 text-primary">
                    <i class="fas fa-robot me-3"></i>
                    Система автоматической оценки экзаменов Enhanced
                </h1>
                <p class="lead text-muted">
                    Загрузите CSV файл с данными экзамена для автоматической оценки с полной предобработкой
                </p>
                <div class="alert alert-info">
                    <i class="fas fa-star me-2"></i>
                    <strong>Enhanced версия:</strong> Включает морфологический анализ, обработку аудио, создание признаков качества речи
                </div>
            </div>
        </div>

        <!-- Форма загрузки -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-upload me-2"></i>
                            Загрузка файла для обработки
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Выберите CSV файл:</label>
                                <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                                <div class="form-text">
                                    <strong>Требования:</strong> CSV с разделителем ";", кодировка UTF-8, без колонки "Оценка экзаменатора"
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-info-circle me-2"></i>Обязательные колонки:</h6>
                                <ul class="mb-0">
                                    <li><code>№ вопроса</code> - номер вопроса (1-4)</li>
                                    <li><code>Текст вопроса</code> - текст задания</li>
                                    <li><code>Транскрибация ответа</code> - текст ответа студента</li>
                                </ul>
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                    <i class="fas fa-magic me-2"></i>
                                    Обработать с Enhanced алгоритмом
                                </button>
                            </div>
                        </form>
                        
                        <!-- Прогресс бар -->
                        <div id="progressContainer" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small id="progressText" class="text-muted">Выполняется полная предобработка данных...</small>
                            </div>
                        </div>
                        
                        <!-- Результат -->
                        <div id="resultContainer" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle me-2"></i>Файл успешно обработан!</h6>
                                <div id="resultStats" class="mb-2"></div>
                                <div id="processingInfo" class="mb-2"></div>
                                <a id="downloadLink" href="#" class="btn btn-success btn-sm">
                                    <i class="fas fa-download me-2"></i>Скачать результат
                                </a>
                            </div>
                        </div>
                        
                        <!-- Ошибки -->
                        <div id="errorContainer" class="mt-3" style="display: none;">
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Ошибка обработки</h6>
                                <p id="errorText" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Возможности Enhanced версии -->
        <div id="features" class="row mb-5">
            <div class="col-12">
                <h2 class="text-center mb-4">Возможности Enhanced версии</h2>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-microphone fa-3x text-primary mb-3"></i>
                        <h5 class="card-title">Обработка аудио</h5>
                        <p class="card-text">
                            Автоматическое скачивание и анализ длительности аудиофайлов для расчета скорости речи
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-language fa-3x text-success mb-3"></i>
                        <h5 class="card-title">Морфологический анализ</h5>
                        <p class="card-text">
                            Глубокий анализ текста с использованием pymorphy3 для оценки качества речи и лексического разнообразия
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                        <h5 class="card-title">Признаки взаимодействия</h5>
                        <p class="card-text">
                            Создание сложных признаков взаимодействия между различными характеристиками ответа
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Пример данных -->
        <div id="example" class="row mb-5">
            <div class="col-12">
                <h3 class="text-center mb-4">Пример входных данных</h3>
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Структура CSV файла</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>№ вопроса</th>
                                        <th>Текст вопроса</th>
                                        <th>Транскрибация ответа</th>
                                        <th>Ссылка на аудио (опционально)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>Расскажите о своем любимом времени года</td>
                                        <td>Мое любимое время года это весна потому что природа просыпается</td>
                                        <td>http://example.com/audio1.mp3</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>Опишите свой обычный день</td>
                                        <td>Утром я встаю завтракаю и иду в школу</td>
                                        <td>http://example.com/audio2.mp3</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>Создаваемые признаки:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="mb-0">
                                        <li>Качество речи</li>
                                        <li>Лексическое разнообразие</li>
                                        <li>Словарный запас</li>
                                        <li>Морфологические признаки</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="mb-0">
                                        <li>Длина и скорость речи</li>
                                        <li>Признаки взаимодействия</li>
                                        <li>TF-IDF векторизация</li>
                                        <li>Автоматическое масштабирование</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статус системы -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Статус системы</h6>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                                <p class="mt-2">Проверка статуса системы...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Система автоматической оценки экзаменов Enhanced</h5>
                    <p class="mb-0">Продвинутое решение с полной предобработкой данных</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">© 2025, Sigma. Все права защищены. Разработано Дмитрием Азаровым.</p>
                    <small class="text-muted">Версия 2.0.0 Enhanced</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enhanced JavaScript для работы с улучшенным API
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const resultContainer = document.getElementById('resultContainer');
            const errorContainer = document.getElementById('errorContainer');
            
            // Загрузка статуса системы
            loadSystemStatus();
            
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('csvFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Пожалуйста, выберите файл');
                    return;
                }
                
                // Показать прогресс
                showProgress();
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/upload-csv/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showResult(result);
                    } else {
                        showError(result.detail || 'Ошибка обработки файла');
                    }
                } catch (error) {
                    showError('Ошибка сети: ' + error.message);
                }
            });
            
            function showProgress() {
                uploadBtn.disabled = true;
                progressContainer.style.display = 'block';
                resultContainer.style.display = 'none';
                errorContainer.style.display = 'none';
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `Обработка... ${Math.round(progress)}%`;
                }, 500);
                
                // Сохраняем интервал для очистки
                window.progressInterval = interval;
            }
            
            function showResult(result) {
                clearInterval(window.progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = 'Завершено!';
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    uploadBtn.disabled = false;
                    
                    // Показать результат с расширенной информацией
                    const statsHtml = `
                        <p><strong>Обработано записей:</strong> ${result.statistics.total_questions}</p>
                        <p><strong>Средняя оценка:</strong> ${result.statistics.average_score.toFixed(2)}</p>
                        <p><strong>Распределение оценок:</strong> ${JSON.stringify(result.statistics.score_distribution)}</p>
                    `;
                    
                    const processingHtml = `
                        <p><strong>Обработка аудио:</strong> ${result.processing_info.audio_processed ? 'Да' : 'Нет'}</p>
                        <p><strong>Созданные признаки:</strong> ${result.processing_info.features_created}</p>
                        <p><strong>Тип модели:</strong> ${result.processing_info.model_type}</p>
                    `;
                    
                    document.getElementById('resultStats').innerHTML = statsHtml;
                    document.getElementById('processingInfo').innerHTML = processingHtml;
                    document.getElementById('downloadLink').href = result.download_url;
                    
                    resultContainer.style.display = 'block';
                }, 1000);
            }
            
            function showError(message) {
                clearInterval(window.progressInterval);
                progressContainer.style.display = 'none';
                uploadBtn.disabled = false;
                
                document.getElementById('errorText').textContent = message;
                errorContainer.style.display = 'block';
            }
            
            async function loadSystemStatus() {
                try {
                    const response = await fetch('/api/processing-status');
                    const status = await response.json();
                    
                    const statusHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Модель загружена:</strong> 
                                    <span class="badge ${status.model_loaded ? 'bg-success' : 'bg-danger'}">
                                        ${status.model_loaded ? 'Да' : 'Нет'}
                                    </span>
                                </p>
                                <p><strong>Тип модели:</strong> ${status.model_type}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Поддерживаемые возможности:</strong></p>
                                <ul class="list-unstyled">
                                    ${status.supported_features.map(feature => `<li><i class="fas fa-check text-success me-2"></i>${feature}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('systemStatus').innerHTML = statusHtml;
                } catch (error) {
                    document.getElementById('systemStatus').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Не удалось загрузить статус системы
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>